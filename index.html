<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
    <title>RA no Antebra√ßo</title>

    <!-- A-Frame + MindAR (CDNs) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html, body { margin:0; height:100%; background:#000; overflow:hidden; }
      .ui { position:fixed; left:0; right:0; bottom:16px; display:flex; gap:12px; justify-content:center; z-index:5 }
      .btn { border:0; padding:10px 14px; border-radius:12px; background:#ffffffcc; font-weight:700 }
      .hint { position:fixed; top:10px; left:0; right:0; text-align:center; color:#fff; font-family:system-ui, sans-serif; z-index:5; }
      .toast { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#111c; color:#fff; padding:10px 14px; border-radius:10px; font-family:system-ui; z-index:10; display:none; text-align:center; }
      .compat { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#000; color:#fff; font:600 16px system-ui; z-index:20; padding:24px; text-align:center; }
    </style>
  </head>
  <body>
    <div class="hint">Aponte a c√¢mera para a pulseira (marcador ao lado do QR)</div>
    <div id="toast" class="toast"></div>
    <div id="compat" class="compat"></div>

    <div class="ui">
      <button class="btn" id="btnPlay">‚ñ∂Ô∏è Reproduzir</button>
      <button class="btn" id="btnMute">üîá Desmutar</button>
      <button class="btn" id="btnPause">‚è∏Ô∏è Pausar</button>
    </div>

    <a-scene
      id="scene"
      mindar-image="imageTargetSrc: ./assets/targets.mind; maxTrack: 1"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-assets timeout="60000">
        <!-- TROQUE para seu arquivo final. Use nome novo p/ ‚Äúquebrar‚Äù cache -->
        <video id="clip"
          src="./assets/clipe-v2.mp4?v=1"
          preload="auto"
          loop
          playsinline
          webkit-playsinline
          muted
          crossorigin="anonymous"></video>
      </a-assets>

      <!-- Target (index 0). Ajuste width/height/position/rotation conforme seu bra√ßo -->
      <a-entity id="anchor" mindar-image-target="targetIndex: 0">
        <a-plane
          id="videoPlane"
          position="0 0.18 0"         <!-- ~18 cm adiante da pulseira; teste 0.10‚Äì0.24 -->
          rotation="-90 0 0"           <!-- paralelo √† pele; se n√£o aparecer, teste 90 0 0 -->
          width="0.22" height="0.12375"<!-- 16:9; ~22 cm x 12,4 cm -->
          material="shader: flat; src: #clip; transparent: true">
        </a-plane>
      </a-entity>
    </a-scene>

    <script>
      const $ = (s)=>document.querySelector(s);
      const video   = $('#clip');
      const btnPlay = $('#btnPlay');
      const btnMute = $('#btnMute');
      const btnPause= $('#btnPause');
      const scene   = $('#scene');
      const toastEl = $('#toast');
      const compatEl= $('#compat');

      let userInteracted = false;

      function toast(msg, t=2400){
        toastEl.textContent = msg;
        toastEl.style.display = 'block';
        setTimeout(()=>toastEl.style.display='none', t);
      }

      // 0) Compatibilidade m√≠nima (getUserMedia + WebGL)
      (async ()=>{
        const webgl2 = !!document.createElement('canvas').getContext('webgl2');
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !webgl2) {
          compatEl.style.display = 'flex';
          compatEl.innerHTML = `
            <div>
              <div style="font-size:22px;margin-bottom:10px;">Falha ao iniciar üòï</div>
              <div>Abra no <b>Chrome (Android)</b> ou <b>Safari (iOS)</b>, com c√¢mera permitida.</div>
            </div>`;
        }
      })();

      // 1) Autoplay silencioso (Android/iOS)
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          video.muted = true;
          await video.play();   // tenta tocar em sil√™ncio
          video.pause();
          video.currentTime = 0;
          console.log('[video] autoplay silencioso ok');
        } catch (e) {
          console.warn('[video] autoplay bloqueado', e);
        }

        // checagem de arquivos
        fetch('./assets/targets.mind')
          .then(r => { if(!r.ok) throw new Error('targets.mind n√£o encontrado'); })
          .catch(e => { console.error(e); toast('Erro: targets.mind ausente em /assets'); });
        fetch('./assets/clipe-v2.mp4?v=1', {cache:'no-store'})
          .then(r => { if(!r.ok) throw new Error('clipe-v2.mp4 n√£o encontrado'); })
          .catch(e => { console.error(e); toast('Erro: clipe (mp4) ausente em /assets'); });

        // checagem de permiss√£o de c√¢mera (√∫til p/ destravar loading infinito)
        navigator.mediaDevices.getUserMedia({video:true})
          .then(()=>console.log('[cam] ok'))
          .catch(err=>{ console.error('[cam] bloqueada', err); toast('Permita a C√¢mera no navegador'); });
      });

      // 2) Gesto para desbloquear √°udio (iOS exige)
      const unlockAudio = async () => {
        userInteracted = true;
        try {
          // ‚Äúnudge‚Äù iOS: tocar mudo, pausar, voltar ao in√≠cio, desmutar e tocar
          video.muted = true;
          await video.play().catch(()=>{});
          video.pause();
          video.currentTime = 0;
          video.muted = false;
          await video.play();
          btnMute.textContent = 'üîä Mutar';
          console.log('[video] play com √°udio ap√≥s gesto');
        } catch (e) {
          console.warn('[video] user-gesture falhou', e);
          toast('Toque novamente em ‚ñ∂Ô∏è/Desmutar para liberar o √°udio');
        }
      };

      btnPlay.addEventListener('click', unlockAudio);
      btnPause.addEventListener('click', () => video.pause());
      btnMute.addEventListener('click', () => {
        video.muted = !video.muted;
        btnMute.textContent = video.muted ? 'üîá Desmutar' : 'üîä Mutar';
      });

      // 3) Eventos do AR (diagn√≥stico)
      scene.addEventListener('arReady', () => console.log('[AR] ready'));
      scene.addEventListener('arError', (e) => {
        console.error('[AR] error', e);
        toast('Erro ao iniciar AR. Verifique permiss√£o da c√¢mera e use Chrome/Safari.');
      });
      scene.addEventListener('targetFound', async () => {
        try {
          if (!userInteracted) video.muted = true; // sem gesto ‚Üí mudo
          await video.play();
          console.log('[AR] targetFound ‚Üí play');
        } catch (e) {
          console.warn('[AR] targetFound play falhou', e);
          toast('Toque em ‚ñ∂Ô∏è e em Desmutar para tocar o v√≠deo');
        }
      });
      scene.addEventListener('targetLost', () => {
        // Se quiser pausar quando perder o marcador, descomente:
        // video.pause();
      });

      // DEBUG: se n√£o ver nada, comente a linha de material acima e use:
      // document.getElementById('videoPlane').setAttribute('material', 'color: #00ffcc');
    </script>
  </body>
</html>
